name: Manage Library and PDFs

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  # JOB 1: FILTRO (Verifica se ci sono modifiche ai file LaTeX o al sito)
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      latex_changed: ${{ steps.filter.outputs.latex }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            latex:
              - 'src/**/*.tex'
              - 'src/**/*.png'
              - 'src/**/*.jpg'
            site:
              - 'scripts/**'
              - '.github/workflows/publish.yml'
              - 'news.txt'

  # JOB 2: COMPILAZIONE SMART (Solo cartelle modificate)
  build_pdfs:
    needs: check_changes
    if: ${{ needs.check_changes.outputs.latex_changed == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # Serve la storia per vedere cosa è cambiato rispetto a prima

      # 1. IDENTIFICA I TARGET DA COMPILARE
      - name: Trova cartelle modificate
        id: find_targets
        run: |
          # Crea un file vuoto per la lista
          touch targets.txt
          
          # Cerca i file cambiati nell'ultimo commit dentro src/
          # Risale alla cartella genitore e controlla se esiste un main.tex
          git diff --name-only HEAD^ HEAD | grep "^src/" | while read filename; do
              dir=$(dirname "$filename")
              # Se il file è in una sottocartella (es. src/Bio/img), risali finché non trovi main.tex
              while [ "$dir" != "." ] && [ "$dir" != "src" ]; do
                  if [ -f "$dir/main.tex" ]; then
                      echo "$dir/main.tex" >> targets.txt
                      break
                  fi
                  dir=$(dirname "$dir")
              done
          done
          
          # Rimuovi duplicati (se ho modificato 2 file nella stessa cartella)
          sort targets.txt | uniq > unique_targets.txt
          
          echo "File da compilare:"
          cat unique_targets.txt
          
          # Se il file è vuoto, non fare nulla
          if [ ! -s unique_targets.txt ]; then
             echo "HAS_TARGETS=false" >> $GITHUB_ENV
          else
             echo "HAS_TARGETS=true" >> $GITHUB_ENV
          fi

      # 2. COMPILA SOLO I TARGET TROVATI
      - name: Compila i file LaTeX modificati
        if: env.HAS_TARGETS == 'true'
        uses: xu-cheng/latex-action@v3
        with:
          # Legge la lista dei file da compilare dal file generato prima
          root_file_list: unique_targets.txt
          work_in_root_file_dir: true
          continue_on_error: true
          args: -pdf -file-line-error -interaction=nonstopmode -f

      # 3. PREPARA ARTEFATTO
      - name: Sposta e Rinomina i PDF
        if: env.HAS_TARGETS == 'true'
        run: |
          mkdir -p public/pdfs
          # Cerca i main.pdf generati (saranno solo quelli delle cartelle toccate)
          find src -name "main.pdf" | while read file; do
              folder=$(basename "$(dirname "$file")")
              echo "Nuovo PDF generato per: $folder"
              mv "$file" "public/pdfs/${folder}.pdf"
          done

      - name: Upload PDFs artifact
        if: env.HAS_TARGETS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: new-pdfs
          path: public/pdfs

  # JOB 3: DEPLOY (MERGE INTELLIGENTE)
  deploy_site:
    needs: [check_changes, build_pdfs]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v3

      - name: Prepara cartella pubblica
        run: mkdir -p public/pdfs

      # 1. RECUPERA TUTTI I VECCHI PDF (Backup dal sito live)
      - name: Recupera PDF esistenti (Base)
        run: |
          echo "Clono il sito attuale per recuperare i vecchi PDF..."
          git clone --branch gh-pages --single-branch https://github.com/${{ github.repository }}.git old_site || true
          if [ -d "old_site/pdfs" ]; then
            cp -r old_site/pdfs/* public/pdfs/
            echo "PDF esistenti recuperati."
          fi
          rm -rf old_site

      # 2. SOVRASCRIVI CON I NUOVI PDF (Se ce ne sono)
      - name: Scarica e Sovrascrivi Nuovi PDF
        if: needs.check_changes.outputs.latex_changed == 'true'
        uses: actions/download-artifact@v4
        continue-on-error: true # Se non c'è artefatto (es. modificato solo README), non fallire
        with:
          name: new-pdfs
          path: public/pdfs
          merge-multiple: true # Unisce i nuovi file nella cartella esistente

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Genera Interfaccia Web
        run: python3 scripts/generate_library.py

      - name: Pubblica su GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: false
